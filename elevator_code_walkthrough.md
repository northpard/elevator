# elevator.ino 코드 문단별 해설

이 문서는 `elevator.ino` 파일을 섹션(문단) 단위로 해설한 문서입니다. 각 섹션에 대해 목적, 주요 변수 및 상수, 동작 요약, 엣지케이스 및 개선 제안을 정리했습니다.

---

## 1) 최상단 주석
- 목적: 스케치의 전체 기능과 하드웨어 전제(입력 방식, LED 구성 등)를 간단히 설명합니다.
- 권장: 배선 다이어그램(간단한 그림)이나 입력 전기적 연결(풀업/저항) 설명을 추가하면 이해가 쉬워집니다.

---

## 2) 핀 매핑
- 주요 항목:
  - 호출 버튼: D11, D12, D13
  - 버튼 LED: D8, D9, D10
  - 층 표시 LED: A0, D4, D7
  - 층간 LED: D2, D3, D5, D6
- 주의사항:
  - 11~13번 핀은 SPI 핀으로 업로드/리셋 시 간섭 가능(부팅 글리치 원인 중 하나).
  - A0는 아날로그 입력이지만 디지털 출력으로 사용할 수 있음.
- 권장:
  - 회로도/사진을 문서에 첨부.
  - 문제가 계속되면 버튼 핀을 SPI 범위 밖으로 옮겨 테스트.

---

## 3) 타이밍 상수
- 상수 설명:
  - DEBOUNCE_MS = 50 (디바운스)
  - MOVE_STEP_MS = 1000 (층간 애니메이션 단계 시간)
  - DOOR_OPEN_MS = 1000 (도어 열림 유지 시간)
- 권장:
  - 이 값들은 사용자 체감이나 회로 노이즈에 따라 조정 가능. 테스트 방법 및 권장 범위를 문서화하세요.

---

## 4) 입력/취소/깜빡임 관련 전역 변수
- 주요 변수:
  - requested[3]: 각 층 호출 요청
  - lastBtnTime[], lastBtnState[]: 디바운스
  - pressStartMillis[], LONG_PRESS_MS: 긴 누름 판정
  - canceledWhileHold[], pressStartedWithActiveRequest[]: 취소 중복 방지 및 시작 상태
  - cancelProtectUntil[], CANCEL_PROTECT_MS: 취소 후 재등록 보호
  - blinkActive[], blinkPhase[] 등: 취소 깜빡임 UX
- 권장:
  - 버튼별 상태를 struct로 묶으면 관리와 확장이 쉬워집니다.

---

## 5) 이동 상태 머신 변수
- enum MoveState { 대기, 상승중, 하강중, 도착처리중 }
- moveStepIndex, moveStepMillis, arrivedMillis, lastMoveDirection 등으로 진행 상태 관리
- 권장:
  - 상태 전환 다이어그램(이미 생성한 Mermaid 순서도와 일치하는지 확인)

---

## 6) setup()
- 역할: 핀 초기화(pinMode/digitalWrite) 및 초기 층 LED 갱신
- 권장:
  - 디버그 시에만 시리얼 로그를 활성화하여 초기 핀 상태(부팅 시점)를 덤프해 보세요.

---

## 7) loop() 호출 순서와 의미
1. readButtons() — 입력 처리
2. updateBlinkStates() — 깜빡임 UX 업데이트
3. syncRequestLedStates() — 요청과 버튼 LED 동기화
4. scheduleNextTargetIfIdle() — 스케줄링(대기 시 목표 선택)
5. runMovement() — 이동/도착 처리

이 순서는 논블로킹 설계에 적합합니다.

---

## 8) syncRequestLedStates()
- 목적: `requested`에 따라 버튼 LED를 켜거나 끕니다. 깜빡임 동작이 켜져 있으면 건드리지 않습니다.

---

## 9) updateBlinkStates()
- 목적: 취소 시 버튼 LED 깜빡임을 관리하는 비차단 상태머신
- 주의: 각 버튼별로 독립 타이머를 사용하므로 동시 깜빡임도 안전합니다.

---

## 10) readButtons() — 핵심 입력 처리
- 동작 요약:
  - 디바운스 적용
  - 짧게 누름 → 즉시 호출 등록
  - 길게 누름(>= LONG_PRESS_MS) → 취소(단, 누를 때 이미 요청이 있었는지 판별)
  - 취소 시 깜빡임 피드백 및 취소 보호 시간 설정
- 주요 엣지 케이스 및 문제점:
  - 짧은 더블-프레스가 취소로 해석되는 경우가 있었음(타이밍 관련).
  - 부팅 직후 핀 글리치로 인한 잘못된 등록 가능성.
- 권장 보수 방안:
  - `requestSetMillis`를 기록해 요청이 막 등록된 경우 취소 후보로 보지 않음(요청 연령 기준).
  - 취소 조건을 더 엄격히(연속 홀드만 허용) 하거나 RELEASE 기반 취소로 변경.
  - 개발 시 `Serial.println`으로 이벤트 로그를 찍어 타이밍을 분석.

---

## 11) scheduleNextTargetIfIdle()
- 정책: 대기 상태이면 가장 가까운 요청을 선택(동률이면 위쪽 우선)
- 권장:
  - 스케줄링 변경(예: 우선순위 큐, 승객 내부 버튼 추가 등)이 필요하면 이 함수에서 확장

---

## 12) runMovement()
- 역할: 층간 LED 애니메이션, 층 도착 판정, 도착 시 처리(도어 열림 시간 적용)
- 동작 포인트:
  - 이동은 두 단계 애니메이션으로 구현됨
  - 도착 시 요청이 있으면 도어 열림 시간을 적용하고, 없으면 곧바로 다음 단계로 진행
- 권장:
  - 내부(캐빈) 버튼이 추가되면 이동 중 입력 처리/우선순위 재검토 필요

---

## 13) arriveAtFloor(), updateFloorLeds()
- arriveAtFloor: 층 LED 갱신 → 도착 시각 기록 → ARRIVING 상태 설정
- updateFloorLeds: 현재층 LED만 켬
- 권장:
  - 도착 시 추가 효과(사운드, 외부 인터록 등)를 이 지점에서 제어하면 좋습니다

---

## 14) pendingAbove(), pendingBelow()
- 역할: 현재층 위/아래에 대기 중인 호출이 있는지 단순 검사
- 권장:
  - 향후 요청(방향 정보 포함) 등 복잡한 로직이 필요하면 확장

---

## 15) 요약 및 우선 개선 항목
1. 취소(길게 누름)와 더블-프레스 오작동 방지: 요청 연령 확인 또는 취소 조건 강화
2. 부팅 글리치 완화: setup()에서 초기 안정화(무시 윈도우) 또는 핀 변경 권장
3. 선택적 디버그 로그 추가로 이벤트 타이밍 확인
4. 버튼 상태를 구조체로 묶어 코드 가독성 개선

---

원하시면 이 파일을 저장소에 추가(커밋/푸시)하고, 취소 관련 보수(간단 패치)를 적용해 드릴 수 있습니다.
